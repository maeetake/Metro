# 交通データ分析スクリプト

日付ソート済み交通乗降客データ (`sorted_output.csv`) を分析し，新学期（中学・高校・大学）の授業開始日を推定するスクリプト．

## 共通データ
以下のCSVファイルを入力とする．

- `sorted_output.csv`: 乗降客の移動記録データ．
- `schools_within_800m.csv`: 学校とその最寄り駅のデータ．

---

## スクリプト詳細

### 1. `school_celemony_prediction.py`

#### 目的
乗降客データと学校の立地情報（最寄り駅）を基に，授業開始日の可能性が高い日付を予測する．

#### 処理フロー
1. **データ読み込み**: 乗降客データ (`--rides`) と学校データ (`--schools`) を読み込む．
2. **データ集計**: 駅ごと・日付ごとの出発人数を計算する．
3. **スパイク検出**:
   - 各駅のデータに対し，過去N日間（デフォルトは7日）の移動中央値を「ベースライン」として計算する．
   - ベースラインと比較して，出発人数が著しく多い日（スパイク）を検出する．
   - スパイクが検出された最初の日を，その駅における「授業開始日の予測日」とする．
   - スパイクが検出できない場合は，フォールバックモード（`--guarantee`）が有効であれば，最大乗客数を記録した日などを代替日として使用する．
4. **全体予測**: 全ての対象駅の予測日から，最も多くの駅で予測された日を「全体の予測日」として決定する．
5. **結果出力**:
   - 駅ごとの予測日と，全体の予測日をコンソールに出力する．
   - 予測日ごとの駅リストを集計したCSV (`ceremony_summary_by_date.csv`) を出力する．
   - オプションで，予測日の分布を示す棒グラフや，各駅の利用者数推移を示す時系列グラフを`outputs`ディレクトリ内に保存する．このディレクトリは実行時に自動生成される．

#### 実行方法

**基本的な実行例:**
```bash
python school_celemony_prediction.py --rides sorted_output.csv --schools schools_within_800m.csv
```

**グラフ出力を有効にする実行例:**
```bash
python school_celemony_prediction.py --rides sorted_output.csv --schools schools_within_800m.csv --bar-chart --timeline
```

#### 主要なコマンドライン引数
| オプション | デフォルト値 | 説明 |
|:---|:---:|:---|
| `--rides` | (必須) | 乗降客データのCSVファイルパス． |
| `--schools` | (必須) | 学校データのCSVファイルパス． |
| `--encoding`| (自動) | CSVファイルのエンコーディング．指定がない場合，`utf-8`, `cp932` などを自動的に試行する． |
| `--window` | `7` | スパイク検出のための移動中央値の計算ウィンドウ（日数）． |
| `--multiplier`| `1.5` | スパイクと判断する閾値（ベースライン値との乗数）． |
| `--min_count`| `50` | スパイク検出の対象となる最小ベースライン乗客数． |
| `--guarantee` / `--no-guarantee` | `True` | スパイクが見つからない場合でも，代替手法を用いて常になんらかの予測日を出力するかどうか． |
| `--bar-chart`| (無効) | 予測日の分布を示す棒グラフを `outputs/ceremony_distribution.png` に保存する． |
| `--timeline` | (無効) | 各駅の時系列グラフを `outputs/timeline_{駅名}.png` に保存する． |

#### 出力
- **コンソール出力**:
  - 駅ごとの予測日一覧．
  - 全体で最も可能性の高い予測日．
- **ファイル出力**:
  - `ceremony_summary_by_date.csv`: 予測日ごとに集計された駅のリスト（常に出力）．
  - `outputs/ceremony_distribution.png`: 予測日の分布を示した棒グラフ（`--bar-chart`指定時）．
  - `outputs/timeline_{駅名}.png`: 各対象駅の利用者数推移と予測日を示した時系列グラフ（`--timeline`指定時）．